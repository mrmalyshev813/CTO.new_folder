# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 504 Gateway Timeout

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü–∞—Ä—Å–µ—Ä —Å–∞–π—Ç–æ–≤ –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É **504 Gateway Timeout** –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≤–µ–±-—Å–∞–π—Ç–æ–≤.

### –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:

1. **–î–æ–ª–≥–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `waitUntil: 'networkidle0'` –∫–æ—Ç–æ—Ä—ã–π –∂–¥–µ—Ç –ø–æ–∫–∞ –í–°–ï —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è (–≤–∫–ª—é—á–∞—è —Ä–µ–∫–ª–∞–º—É, –∞–Ω–∞–ª–∏—Ç–∏–∫—É, —Ç—Ä–µ–∫–µ—Ä—ã), —á—Ç–æ –º–æ–≥–ª–æ –∑–∞–Ω–∏–º–∞—Ç—å 30+ —Å–µ–∫—É–Ω–¥
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤**: Fetch –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∏–º–µ–ª–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –º–æ–≥–ª–∏ –∑–∞–≤–∏—Å–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
3. **–õ–∏–º–∏—Ç—ã Netlify Functions**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ ~26 —Å–µ–∫—É–Ω–¥, –∞ –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å (screenshot + AI –∞–Ω–∞–ª–∏–∑ + scraping + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –º–æ–≥ –∑–∞–Ω–∏–º–∞—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è screenshot.js

**–ë—ã–ª–æ:**
```javascript
await page.goto(url, { 
    waitUntil: 'networkidle0',  // –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –í–°–ï–• –∑–∞–ø—Ä–æ—Å–æ–≤
    timeout: 30000               // 30 —Å–µ–∫—É–Ω–¥
});
```

**–°—Ç–∞–ª–æ:**
```javascript
await page.goto(url, { 
    waitUntil: 'domcontentloaded',  // –ñ–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    timeout: 15000                   // 15 —Å–µ–∫—É–Ω–¥
});
// Wait a bit for dynamic content to render
await new Promise(resolve => setTimeout(resolve, 2000)); // +2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚ö° –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ
- ‚úÖ –ù–µ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–æ–≤ –∏ —Ç—Ä–µ–∫–µ—Ä–æ–≤
- üéØ –î–∞–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ –≤ analyze.js

**–¢–∞–π–º–∞—É—Ç –¥–ª—è screenshot –∑–∞–ø—Ä–æ—Å–∞:**
```javascript
const screenshotController = new AbortController();
const screenshotTimeout = setTimeout(() => screenshotController.abort(), 20000);

const screenshotResponse = await fetch(`${process.env.URL}/.netlify/functions/screenshot`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url }),
    signal: screenshotController.signal
});
clearTimeout(screenshotTimeout);
```

**–¢–∞–π–º–∞—É—Ç –¥–ª—è scraping –∑–∞–ø—Ä–æ—Å–∞:**
```javascript
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 10000);

const response = await fetch(url, {
    headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; AdlookBot/1.0)'
    },
    signal: controller.signal
});
clearTimeout(timeout);
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚è±Ô∏è Screenshot fetch —Ç–∞–π–º–∞—É—Ç: 20 —Å–µ–∫—É–Ω–¥
- ‚è±Ô∏è Website scraping —Ç–∞–π–º–∞—É—Ç: 10 —Å–µ–∫—É–Ω–¥
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```javascript
// Check if it's a timeout error
let errorMessage = error.message;
let statusCode = 500;

if (error.name === 'AbortError' || error.message.includes('abort')) {
    errorMessage = 'Request timeout: The website took too long to respond. Please try again or check if the website is accessible.';
    statusCode = 504;
}

return {
    statusCode: statusCode,
    headers: { 
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
    },
    body: JSON.stringify({
        success: false,
        error: errorMessage
    })
};
```

**–£–ª—É—á—à–µ–Ω–∏—è:**
- üìù –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üî¢ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥ (504) –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤
- üéØ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ (timeout vs server error)

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:

| –û–ø–µ—Ä–∞—Ü–∏—è | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|------|-------|-----------|
| –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã | –¥–æ 30 —Å–µ–∫ | 15-17 —Å–µ–∫ | ‚ö° 2x –±—ã—Å—Ç—Ä–µ–µ |
| Screenshot fetch | –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–∞ | 20 —Å–µ–∫ max | ‚úÖ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è |
| Website scraping | –±–µ–∑ —Ç–∞–π–º–∞—É—Ç–∞ | 10 —Å–µ–∫ max | ‚úÖ –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è |
| **–û–±—â–µ–µ –≤—Ä–µ–º—è** | 30-60+ —Å–µ–∫ | 20-25 —Å–µ–∫ | ‚ö° –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ |

### –£–ª—É—á—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:

‚úÖ **–ù–µ—Ç –æ—à–∏–±–æ–∫ 504** - –ø—Ä–æ—Ü–µ—Å—Å —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –ª–∏–º–∏—Ç—ã Netlify Functions  
‚úÖ **–¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - –Ω–µ—Ç –∑–∞–≤–∏—Å—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π  
‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ  
‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ  

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
node test-504-fix.js
```

–í—Å–µ 10 —Ç–µ—Å—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ.

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤**: –¢–µ–∫—É—â–∏–µ —Ç–∞–π–º–∞—É—Ç—ã (15 —Å–µ–∫ –¥–ª—è screenshot, 10 —Å–µ–∫ –¥–ª—è scraping) –º–æ–≥—É—Ç –±—ã—Ç—å —É–≤–µ–ª–∏—á–µ–Ω—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ Netlify Functions –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
3. **Retry –ª–æ–≥–∏–∫–∞**: –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `netlify/functions/screenshot.js` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
- `netlify/functions/analyze.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `test-504-fix.js` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ü–æ—á–µ–º—É domcontentloaded –≤–º–µ—Å—Ç–æ networkidle0?

- `networkidle0`: –ñ–¥–µ—Ç –ø–æ–∫–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è (0 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ —Ç–µ—á–µ–Ω–∏–µ 500ms)
  - ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–æ (–∂–¥–µ—Ç —Ä–µ–∫–ª–∞–º—É, –∞–Ω–∞–ª–∏—Ç–∏–∫—É, —Ç—Ä–µ–∫–µ—Ä—ã)
  - ‚ùå –ú–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞ —Å–∞–π—Ç–∞—Ö —Å –∞–∫—Ç–∏–≤–Ω—ã–º polling
  
- `domcontentloaded`: –ñ–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ JavaScript
  - ‚úÖ –ë—ã—Å—Ç—Ä–æ (–æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω)
  - ‚úÖ –ù–∞–¥–µ–∂–Ω–æ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤)
  - ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤

Modern way –¥–ª—è –æ—Ç–º–µ–Ω—ã fetch –∑–∞–ø—Ä–æ—Å–æ–≤:
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ Node.js
- –ß–∏—Å—Ç–∞—è –æ—Ç–º–µ–Ω–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
- –ü–æ–∑–≤–æ–ª—è–µ—Ç gracefully –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ —Ç–∞–π–º–∞—É—Ç—É
